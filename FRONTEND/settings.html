<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
    <title>Settings - Language Learning Platform</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
</head>

<body class="is-preload">

    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Main -->
        <div id="main">
            <div class="inner">

                <!-- Header -->
                <header id="header">
                    <a href="dashboard.html" class="logo"><strong>Language Platform</strong></a>
                </header>

                <!-- Banner -->
                <section id="banner">
                    <div class="content">
                        <header>
                            <h1>Account Settings</h1>
                            <p>View your profile and manage your account.</p>
                        </header>
                    </div>
                    <span class="image object">
                        <img src="images/settings.jpg" alt="Settings" />
                    </span>
                </section>


                <section id="account-settings">
                    <header class="major">
                        <h2>Account Settings</h2>
                    </header>
                    <div id="profileInfo">
                        <p><strong>Name:</strong> <span id="userFullName">Loading...</span></p>
                        <p><strong>Email:</strong> <span id="userEmail">Loading...</span></p>
                    </div>
                    <hr />
                    <h3>Edit Profile</h3>
                    <form id="editProfileForm">
                        <label for="firstName">First Name:</label>
                        <input type="text" id="firstName" name="firstName" required />
                        <label for="lastName">Last Name:</label>
                        <input type="text" id="lastName" name="lastName" required />
                        <button type="submit" class="button">Update Profile</button>
                    </form>

                    <hr />
                    <h3>Change Password</h3>
                    <form id="changePasswordForm">
                        <label for="currentPassword">Current Password:</label>
                        <input type="password" id="currentPassword" name="currentPassword" required />
                        <label for="newPassword">New Password:</label>
                        <input type="password" id="newPassword" name="newPassword" required />
                        <button type="submit" class="button">Change Password</button>
                    </form>
                    <hr />
                    <button id="deleteAccountBtn" class="button">Delete Account</button>
                </section>

            </div>
        </div>

        <!-- Sidebar -->
        <div id="sidebar">
            <div class="inner">

                <!-- Search -->
                <section id="search" class="alt">
                    <form method="post" action="#">
                        <input type="text" name="query" id="query" placeholder="Search" />
                    </form>
                </section>

                <!-- Menu -->
                <nav id="menu">
                    <header class="major">
                        <h2>Menu</h2>
                    </header>
                    <ul>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="quiz.html">Take a Quiz</a></li>
                        <li><a href="quiz-history.html">Quiz History</a></li>
                        <li><a href="settings.html">Settings</a></li>
                        <li><button id="logoutBtn" class="button">Logout</button></li>
                    </ul>
                </nav>

                <!-- Section -->
                <section>
                    <header class="major">
                        <h2>Ante interdum</h2>
                    </header>
                    <div class="mini-posts">
                        <article>
                            <a href="#" class="image"><img src="images/pic07.jpg" alt="" /></a>
                            <p>Aenean ornare velit lacus, ac varius enim lorem ullamcorper dolore aliquam.</p>
                        </article>
                        <article>
                            <a href="#" class="image"><img src="images/pic08.jpg" alt="" /></a>
                            <p>Aenean ornare velit lacus, ac varius enim lorem ullamcorper dolore aliquam.</p>
                        </article>
                        <article>
                            <a href="#" class="image"><img src="images/pic09.jpg" alt="" /></a>
                            <p>Aenean ornare velit lacus, ac varius enim lorem ullamcorper dolore aliquam.</p>
                        </article>
                    </div>
                    <ul class="actions">
                        <li><a href="#" class="button">More</a></li>
                    </ul>
                </section>

                <!-- Section -->
                <section>
                    <header class="major">
                        <h2>Get in touch</h2>
                    </header>
                    <p>Sed varius enim lorem ullamcorper dolore aliquam aenean ornare velit lacus, ac varius enim lorem
                        ullamcorper dolore. Proin sed aliquam facilisis ante interdum. Sed nulla amet lorem feugiat
                        tempus aliquam.</p>
                    <ul class="contact">
                        <li class="icon solid fa-envelope"><a href="#">information@untitled.tld</a></li>
                        <li class="icon solid fa-phone">(000) 000-0000</li>
                        <li class="icon solid fa-home">1234 Somewhere Road #8254<br />
                            Nashville, TN 00000-0000</li>
                    </ul>
                </section>

                <!-- Footer -->
                <footer id="footer">
                    <p class="copyright">&copy; Untitled. All rights reserved. Demo Images: <a
                            href="https://unsplash.com">Unsplash</a>. Design: <a href="https://html5up.net">HTML5
                            UP</a>.</p>
                </footer>

            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="js/logout.js"></script>
    <script>
        // Redirect if not logged in or user object is invalid
        const token = localStorage.getItem("token");
        const user = JSON.parse(localStorage.getItem("user"));

        if (!token || !user || !user.email) {
            window.location.href = 'login.html';
        }

        // Display user info
        document.getElementById("userFullName").textContent = user.firstName + " " + user.lastName;
        document.getElementById("userEmail").textContent = user.email;

        // Hide delete button for admins
        if (user.role === "ADMIN") {
            document.getElementById("deleteAccountBtn").style.display = "none";
        }

        // Handle account deletion
        document.getElementById("deleteAccountBtn").addEventListener("click", function () {
            if (confirm("Are you sure you want to delete your account? This action cannot be undone.")) {
                fetch("http://localhost:8080/api/user/delete", {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                }).then(response => {
                    if (response.ok) {
                        alert("Account deleted successfully.");
                        localStorage.clear();
                        window.location.href = "login.html";
                    } else {
                        alert("Failed to delete account.");
                    }
                }).catch(() => {
                    alert("Error occurred. Try again later.");
                });
            }
        });

        // Handle profile update
        document.getElementById("editProfileForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const updatedUser = {
                firstName: document.getElementById("firstName").value,
                lastName: document.getElementById("lastName").value,
                email: user.email
            };
            fetch("http://localhost:8080/api/user/update", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(updatedUser)
            })
                .then(res => {
                    if (res.ok) {
                        alert("Profile updated successfully.");
                        localStorage.setItem("user", JSON.stringify(updatedUser));
                        window.location.reload();
                    } else {
                        alert("Failed to update profile.");
                    }
                }).catch(() => {
                    alert("Network error. Please try again.");
                });
        });

        // Handle password change
        document.getElementById("changePasswordForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const data = {
                email: user.email,
                currentPassword: document.getElementById("currentPassword").value,
                newPassword: document.getElementById("newPassword").value
            };
            fetch("http://localhost:8080/api/auth/change-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(data)
            })
                .then(res => {
                    if (res.ok) {
                        alert("Password changed successfully.");
                        document.getElementById("changePasswordForm").reset();
                    } else {
                        alert("Failed to change password.");
                    }
                }).catch(() => {
                    alert("Network error. Please try again.");
                });
        });

        // Pre-fill form with current user info
        document.getElementById("firstName").value = user.firstName;
        document.getElementById("lastName").value = user.lastName;
    </script>

</body>

</html>